<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Khushipath User Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --user-primary: #009688; /* Teal/Green for User Panel */
            --user-secondary: #ff9800; /* Orange for Highlights */
            --bg-color: #f7f7f7;
        }
        body { 
            margin: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-color); 
        }
        .header {
            background-color: var(--user-primary);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 1.8em;
        }
        .logout-btn {
            background-color: var(--user-secondary);
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .logout-btn:hover {
            background-color: #fb8c00;
        }

        .dashboard-layout {
            display: flex;
            max-width: 1200px;
            margin: 30px auto;
            gap: 20px;
        }
        
        /* User Sidebar Navigation */
        .user-nav {
            flex: 1; /* Takes 1 part of the space */
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            padding: 20px;
            height: fit-content;
        }
        .user-nav ul {
            list-style: none;
            padding: 0;
        }
        .user-nav a {
            display: block;
            padding: 12px 10px;
            color: #333;
            text-decoration: none;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .user-nav a:hover {
            background-color: #e0f2f1; /* Light teal hover */
            color: var(--user-primary);
        }
        .user-nav i {
            margin-right: 10px;
            color: var(--user-primary);
        }

        /* Main Content Area */
        .main-panel {
            flex: 3; /* Takes 3 parts of the space */
        }
        .info-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stat-box {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-box .count {
            font-size: 2em;
            color: var(--user-primary);
            font-weight: bold;
        }
        .stat-box .label {
            color: #555;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="welcomeUserHeader">Welcome, User! </h1> 
        <a href="/logout" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <div class="dashboard-layout">
        
        <div class="user-nav">
            <h3 style="color: var(--user-primary); margin-top: 0;">My Account</h3>
            <ul>
                <li><a href="/user/dashboard"><i class="fas fa-tachometer-alt"></i> Overview</a></li>
                <li><a href="#"><i class="fas fa-file-alt"></i> My Test Reports</a></li>
                <li><a href="/user/appointments"><i class="fas fa-calendar-alt"></i> Upcoming Appointments</a></li>
                <li><a href="#"><i class="fas fa-user-edit"></i> Edit Profile</a></li>
                <li><a href="#"><i class="fas fa-bell"></i> Notifications</a></li>
            </ul>
        </div>

        <div class="main-panel">
            
            <div class="info-card">
                <h2>Quick Summary</h2>
                <div class="card-grid">
                    <div class="stat-box">
                        <div class="count" id="totalReportsCount">...</div> 
                        <div class="label">Total Reports</div>
                    </div>
                    <div class="stat-box">
                        <div class="count" id="upcomingTestsCount" style="color: var(--user-secondary);">...</div> 
                        <div class="label">Upcoming Tests</div>
                    </div>
                    <div class="stat-box">
                        <div class="count" id="pendingPaymentsCount">...</div> 
                        <div class="label">Pending Payments</div>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <h2>Latest Test Results</h2>
                <div id="latestResultsContainer"> 
                    <p>Loading results...</p>
                </div>
                <a href="#" style="color: var(--user-primary); margin-top: 10px; display: block;">View All Reports â†’</a>
            </div>
            
        </div>
    </div>
    <script>
        // Helper function for status styling
        function getStatusStyle(status) {
            if (status === 'Ready') return 'color: green; font-weight: bold;';
            if (status === 'Archived') return 'color: gray;';
            if (status === 'Pending Payment') return 'color: orange; font-weight: bold;';
            return 'color: #555;';
        }

        async function fetchDashboardData() {
            try {
                // ðŸ”‘ Call the protected route we designed in server.js
                const response = await fetch('/api/user/summary');
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert("Session expired. Redirecting to login.");
                        window.location.href = '/Login';
                        return;
                    }
                    throw new Error('Failed to fetch dashboard data.');
                }
                
                const data = await response.json();

                // 1. Update Welcome Header (Optional, requires server to return username)
                // document.getElementById('welcomeUserHeader').textContent = `Welcome, ${data.username || 'User'}!`;
                
                // 2. Populate Quick Summary
                document.getElementById('totalReportsCount').textContent = data.totalReports;
                document.getElementById('upcomingTestsCount').textContent = data.upcomingTests;
                document.getElementById('pendingPaymentsCount').textContent = data.pendingPayments;

                // 3. Populate Latest Test Results
                const resultsContainer = document.getElementById('latestResultsContainer');
                resultsContainer.innerHTML = '';

                if (data.latestResults && data.latestResults.length > 0) {
                    data.latestResults.forEach(report => {
                        const statusStyle = getStatusStyle(report.status);
                        const p = document.createElement('p');
                        const displayId = report.reportId ? "KH" + report.reportId.substring(report.reportId.length - 4) + "**" : 'N/A';
                        
                        p.innerHTML = `
                            Report ID: <b>${displayId}</b> - Status: 
                            <span style="${statusStyle}">${report.status}</span> 
                        `;
                        resultsContainer.appendChild(p);
                    });
                } else {
                    resultsContainer.innerHTML = '<p>No recent reports available. Book a test today!</p>';
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('latestResultsContainer').innerHTML = '<p style="color: red;">Failed to load summary data.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', fetchDashboardData);
    </script>
</body>
</html>